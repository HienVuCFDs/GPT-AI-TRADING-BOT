{% extends "admin/base_dashboard.html" %}

{% block title %}{% if action == 'add' %}C·∫•p License{% else %}S·ª≠a License{% endif %}{% endblock %}

{% block page_title %}{% if action == 'add' %}C·∫•p License Cho User{% else %}Ch·ªânh S·ª≠a License{% endif %}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card-custom">
            <div class="card-header-custom">
                <h5>
                    <i class="bi bi-{% if action == 'add' %}key{% else %}pencil-square{% endif %} me-2"></i>
                    {% if action == 'add' %}C·∫•p License Cho User{% else %}Ch·ªânh S·ª≠a License{% endif %}
                </h5>
                <a href="{% url 'dashboard_licenses' %}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Quay l·∫°i
                </a>
            </div>
            <div class="card-body-custom">
                <form method="post">
                    {% csrf_token %}
                    
                    {% if action == 'add' %}
                    <!-- Ch·ªçn User -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ch·ªçn Ng∆∞·ªùi D√πng <span class="text-danger">*</span></label>
                        <select name="user_id" class="form-select" required>
                            <option value="">-- Ch·ªçn ng∆∞·ªùi d√πng --</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}" 
                                    {% if preselect_user_id and user.id|stringformat:"s" == preselect_user_id %}selected{% endif %}
                                    {% if user.licenses.count == 0 %}style="color: #dc3545;"{% endif %}>
                                {{ user.username }} 
                                ({{ user.email|default:"Kh√¥ng c√≥ email" }})
                                {% if user.licenses.count == 0 %} - ‚ö†Ô∏è Ch∆∞a c√≥ License{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">User c√≥ m√†u ƒë·ªè l√† ch∆∞a ƒë∆∞·ª£c c·∫•p License</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Lo·∫°i License</label>
                            <select name="license_type" class="form-select" id="licenseType" onchange="updateDuration()">
                                <option value="trial" data-days="7">üéÅ Trial (D√πng th·ª≠)</option>
                                <option value="monthly" data-days="30">üìÖ Monthly (H√†ng th√°ng)</option>
                                <option value="quarterly" data-days="90">üìÜ Quarterly (H√†ng qu√Ω)</option>
                                <option value="yearly" data-days="365">üìÜ Yearly (H√†ng nƒÉm)</option>
                                <option value="lifetime" data-days="3650">‚ôæÔ∏è Lifetime (Vƒ©nh vi·ªÖn)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">S·ªë thi·∫øt b·ªã t·ªëi ƒëa</label>
                            <input type="number" name="max_devices" class="form-control" value="1" min="1" max="10">
                        </div>
                    </div>
                    
                    <!-- S·ªë ng√†y t√πy ch·ªçn -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Th·ªùi h·∫°n (s·ªë ng√†y) <span class="text-danger">*</span></label>
                            <input type="number" name="duration_days" id="durationDays" class="form-control" 
                                   value="7" min="1" max="36500" required>
                            <small class="text-muted">Nh·∫≠p s·ªë ng√†y t√πy √Ω (1 - 36500)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Ho·∫∑c ch·ªçn nhanh</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setDays(7)">7 ng√†y</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setDays(14)">14 ng√†y</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setDays(30)">30 ng√†y</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setDays(90)">90 ng√†y</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setDays(365)">1 nƒÉm</button>
                            </div>
                        </div>
                    </div>
                    
                    {% else %}
                    <!-- Edit mode -->
                    <div class="alert alert-secondary">
                        <i class="bi bi-person me-2"></i>
                        <strong>Ng∆∞·ªùi d√πng:</strong> {{ edit_license.user.username }} ({{ edit_license.user.email|default:"Kh√¥ng c√≥ email" }})
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">License Key</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" value="{{ edit_license.license_key }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText('{{ edit_license.license_key }}'); alert('ƒê√£ copy!')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Lo·∫°i License</label>
                            <select name="license_type" class="form-select">
                                <option value="trial" {% if edit_license.license_type == 'trial' %}selected{% endif %}>üéÅ Trial (D√πng th·ª≠)</option>
                                <option value="monthly" {% if edit_license.license_type == 'monthly' %}selected{% endif %}>üìÖ Monthly (H√†ng th√°ng)</option>
                                <option value="quarterly" {% if edit_license.license_type == 'quarterly' %}selected{% endif %}>üìÜ Quarterly (H√†ng qu√Ω)</option>
                                <option value="yearly" {% if edit_license.license_type == 'yearly' %}selected{% endif %}>üìÜ Yearly (H√†ng nƒÉm)</option>
                                <option value="lifetime" {% if edit_license.license_type == 'lifetime' %}selected{% endif %}>‚ôæÔ∏è Lifetime (Vƒ©nh vi·ªÖn)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">S·ªë thi·∫øt b·ªã t·ªëi ƒëa</label>
                            <input type="number" name="max_devices" class="form-control" 
                                   value="{{ edit_license.max_devices }}" min="1" max="10">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Tr·∫°ng th√°i</label>
                            <select name="status" class="form-select">
                                <option value="active" {% if edit_license.status == 'active' %}selected{% endif %}>‚úÖ Active (Ho·∫°t ƒë·ªông)</option>
                                <option value="expired" {% if edit_license.status == 'expired' %}selected{% endif %}>‚è∞ Expired (H·∫øt h·∫°n)</option>
                                <option value="suspended" {% if edit_license.status == 'suspended' %}selected{% endif %}>‚õî Suspended (T·∫°m ng∆∞ng)</option>
                                <option value="revoked" {% if edit_license.status == 'revoked' %}selected{% endif %}>üö´ Revoked (Thu h·ªìi)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Ng√†y h·∫øt h·∫°n</label>
                            <input type="date" name="expire_date" class="form-control" 
                                   value="{{ edit_license.expire_date|date:'Y-m-d' }}">
                        </div>
                    </div>
                    
                    <!-- Gia h·∫°n t√πy ch·ªçn -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-calendar-plus me-2"></i>Gia h·∫°n th√™m</h6>
                            <div class="row align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label small">S·ªë ng√†y gia h·∫°n</label>
                                    <input type="number" name="extend_days" class="form-control" 
                                           placeholder="VD: 30" min="1" max="3650">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small">Ho·∫∑c ch·ªçn nhanh</label>
                                    <div class="btn-group" role="group">
                                        <button type="submit" name="extend_quick" value="7" class="btn btn-outline-success btn-sm">+7 ng√†y</button>
                                        <button type="submit" name="extend_quick" value="14" class="btn btn-outline-success btn-sm">+14 ng√†y</button>
                                        <button type="submit" name="extend_quick" value="30" class="btn btn-outline-success btn-sm">+30 ng√†y</button>
                                        <button type="submit" name="extend_quick" value="90" class="btn btn-outline-success btn-sm">+90 ng√†y</button>
                                        <button type="submit" name="extend_quick" value="365" class="btn btn-outline-success btn-sm">+1 nƒÉm</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tr·ª´ th·ªùi h·∫°n -->
                    <div class="card bg-light mb-3 border-danger">
                        <div class="card-body">
                            <h6 class="card-title text-danger"><i class="bi bi-calendar-minus me-2"></i>Tr·ª´ th·ªùi h·∫°n</h6>
                            <div class="row align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label small">S·ªë ng√†y tr·ª´</label>
                                    <input type="number" name="reduce_days" class="form-control" 
                                           placeholder="VD: 7" min="1" max="3650">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label small">Ho·∫∑c ch·ªçn nhanh</label>
                                    <div class="btn-group" role="group">
                                        <button type="submit" name="reduce_quick" value="7" class="btn btn-outline-danger btn-sm">-7 ng√†y</button>
                                        <button type="submit" name="reduce_quick" value="14" class="btn btn-outline-danger btn-sm">-14 ng√†y</button>
                                        <button type="submit" name="reduce_quick" value="30" class="btn btn-outline-danger btn-sm">-30 ng√†y</button>
                                        <button type="submit" name="reduce_quick" value="90" class="btn btn-outline-danger btn-sm">-90 ng√†y</button>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">‚ö†Ô∏è L∆∞u √Ω: N·∫øu tr·ª´ nhi·ªÅu h∆°n s·ªë ng√†y c√≤n l·∫°i, license s·∫Ω h·∫øt h·∫°n ngay l·∫≠p t·ª©c.</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Th√¥ng tin:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Ng√†y t·∫°o: {{ edit_license.created_at|date:"d/m/Y H:i" }}</li>
                            <li>Thi·∫øt b·ªã ƒë√£ k√≠ch ho·∫°t: {{ edit_license.activations.count }}/{{ edit_license.max_devices }}</li>
                            <li>C√≤n l·∫°i: 
                                {% if edit_license.days_remaining > 0 %}
                                    <span class="text-success fw-bold">{{ edit_license.days_remaining }} ng√†y</span>
                                {% elif edit_license.days_remaining == 0 %}
                                    <span class="text-warning fw-bold">H·∫øt h·∫°n h√¥m nay</span>
                                {% else %}
                                    <span class="text-danger fw-bold">ƒê√£ h·∫øt h·∫°n</span>
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'dashboard_licenses' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg me-1"></i> H·ªßy
                        </a>
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="bi bi-check-lg me-1"></i>
                            {% if action == 'add' %}C·∫•p License{% else %}L∆∞u Thay ƒê·ªïi{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function setDays(days) {
    document.getElementById('durationDays').value = days;
}

function updateDuration() {
    const select = document.getElementById('licenseType');
    const option = select.options[select.selectedIndex];
    const days = option.getAttribute('data-days');
    document.getElementById('durationDays').value = days;
}
</script>
{% endblock %}
